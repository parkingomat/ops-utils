# FreeBSD's Installation

These scripts auto-install FreeBSD, baseline harden it, and configure it with 3 jails. See:
https://blog.uxtely.com/freebsd-jails-network-setup

The configuration files in this directory match the structure they're
going to be in the final server. These configs are tarred beforehand,
and copied over to `/tmp/UxtelyInstallerConfigs/setups`, along with the installer 
scripts.

We serve them from: `https://orch.example.com/setups/`

Each script part ends up printing a banner. If it doesn't print, something
went wrong. For that, the scripts have `set -o errexit`, and a few tests,
but not much tracing information. Also, each script gets deleted if it
didn't fail; so you can check for that too (if you missed the banners).

**Temporary dummy files.**
These files are just to allow the jails to boot fine during the installation.
- `nginx_j` **needs** self-signed certificates
- `node_j` has a temp `main.js`


### init-location-installer-bundle.sh
From your laptop, it creates the installation scripts and configs.

Overview:
- Prompts for general info (IP, GW, Host Username, etc.)
- Creates local SSH Keys
- Creates a disk encryption password
- Copies the config tars, keys, and installer scripts


### installerconfig.sh
Manually triggered in the server with: 
```shell script
/usr/sbin/bsdinstall script /tmp/installerconfig.sh
```
- Installs the OS
- ↓ Downloads and runs `installerconfig-part2.sh`

### installerconfig-part2.sh
- Untars the configs, creates jails, installs updates, etc. 
- ↓ Downloads and extracts `base.tar` and `jails.tar`
- ↓ Downloads `installerconfig-part3.sh` and sets it to run on the next boot
- Reboots

### installerconfig-part3.sh (first boot)
- Runs the `/setup.sh` of each jail. 
    - Each one installs jail packages and configures the jail. 
- Creates the root passwords, which get tarred in the home directory.

All this is done on the first boot. That's because it's easier to use paths like
`/jails` instead of `/mnt/jails`. That is, the `bsdinstall` is chroot'd under `/mnt`.


## Special Configs
Although `/location-server` has most of the files, (installation
scripts, and configs) there are a few exceptions:

- `postgres.conf` and `pg_hba.conf` are generated by the `/jails/pg_j/setup.sh`
- Common configs, like the timezone file, are copied over
to the template jail by `installerconfig-part2.sh`

The following files get modified in-place:
- The jails' `rc.conf` by their corresponding `/setup.sh`


## Troubleshooting
The `bsdinstall` error popup eats away any useful error message from the screen. To see
the error messages, add `/bin/sh` or `sleep 60` at the end of any of the first two parts.

Common problems:
- The orchestration server is not up
- Some device didn't unmount like `/dev/cd`
  - `pwait` or `sleep 2` help to finish killing some processes. 
